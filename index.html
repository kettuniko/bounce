<html>
  <head>
    <style>
      html, body { margin: 0; }
    </style>
    <script src="Bacon.js"></script>
    <script src="lodash.js"></script>
  </head>
  <body>
    <canvas id="canvas"></canvas>
  </body>

  <script>
    document.body.style.backgroundColor = randomCssRgba()
    
      var canvas  = document.getElementById('canvas'),
          context = canvas.getContext('2d'),
          balls   = _.times(50, createBall)

      canvas.width  = window.innerWidth
      canvas.height = window.innerHeight

      requestAnimationFrame(reDrawAll)

      function reDrawAll() {
        context.clearRect(0, 0, window.innerWidth, window.innerHeight)
        _.invoke(balls, 'move')
        requestAnimationFrame(reDrawAll)
      }

      function createBall() {
        var speed = randomNumber(1, 2)

        var goingDown = randomBoolean(), goingRight = randomBoolean()

        var backgroundColor = randomCssRgba(),
            borderColor     = randomCssRgba(),
            borderWidth     = randomNumber(0, 30),
            radius          = randomNumber(5, 120),
            realRadius      = radius + (borderWidth / 2),
            initialX        = randomNumber(realRadius, window.innerWidth - realRadius),
            initialY        = randomNumber(realRadius, window.innerHeight - realRadius)

        var positionStream    = new Bacon.Bus(),
            positionProperty  = positionStream.toProperty({ x: initialX, y: initialY }),
            hitsTopOrBottom   = positionStream.map('.y').filter(isAtMaxBoundary, 'innerHeight'),
            hitsRightOrLeft   = positionStream.map('.x').filter(isAtMaxBoundary, 'innerWidth')

        positionProperty.onValue(reDraw)
        hitsTopOrBottom.onValue(flipY)
        hitsRightOrLeft.onValue(flipX)

        function reDraw(position) {
          context.beginPath()
          context.arc(position.x, position.y, radius, 0, 2 * Math.PI)

          context.fillStyle   = backgroundColor
          context.lineWidth   = borderWidth
          context.strokeStyle = borderColor

          context.fill()
          context.stroke()
        }

        function isAtMaxBoundary(dimension, position) { return position - realRadius <= 0 || position + realRadius >= window[dimension] }

        function flipY() { goingDown  = !goingDown }
        function flipX() { goingRight = !goingRight }

        function nextX(currentX) { return goingRight ? currentX + speed : currentX - speed }
        function nextY(currentY) { return goingDown ? currentY + speed : currentY - speed }

        function toNextPosition(position) { return { x: nextX(position.x), y: nextY(position.y) } }
        function moveBall(position) { positionStream.push(position) }

        return {
          move: function(){
            positionProperty.first().map(toNextPosition).onValue(moveBall)
          }
        }
      }

      function randomCssRgba () { return _.template('rgba(${rgba})')({rgba: _.times(3, randomColorNumber).concat(randomAlpha()).join(',')}) }
      function randomAlpha () { return randomNumber(50, 100) * 0.01 }
      function randomColorNumber() { return randomNumber(0, 255) }
      function randomNumber(min ,max) { return Math.floor(Math.random() * (max - min + 1) + min) }
      function randomBoolean() { return Math.random() >= 0.5 }
  </script>
</html>
